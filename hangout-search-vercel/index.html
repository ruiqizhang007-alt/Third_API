<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hangout Planner · 免费联网版</title>
<style>
:root{--ink:#1f2937;--muted:#6b7280;--b:#e5e7eb;--accent:#2563eb}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f6f7fb;color:var(--ink)}
.bg{position:fixed;inset:0;background:url('assets/bg.png') center/cover no-repeat;opacity:.15;pointer-events:none}
.wrap{position:relative;max-width:1000px;margin:24px auto;padding:0 14px}
.panel{background:#fff;border:1px solid var(--b);border-radius:16px;padding:16px;box-shadow:0 4px 24px rgba(0,0,0,.06)}
h1{margin:0 0 8px;font-size:22px}
label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--b);border-radius:10px;background:#fff}
.row{display:grid;gap:10px}@media(min-width:860px){.row{grid-template-columns:repeat(3,1fr)}}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--b);border-radius:10px;background:#fff;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.grid{display:grid;gap:12px}@media(min-width:860px){.grid{grid-template-columns:2fr 1fr}}
.card{background:#fff;border:1px solid var(--b);border-radius:14px;padding:12px}
.place{border:1px dashed #e5e7eb;border-radius:10px;padding:8px}
.timeline{border-left:2px solid #d1d5db;padding-left:12px}
.code{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap}
small.hint{display:block;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<div class="bg"></div>
<div class="wrap">
  <div class="panel">
    <h1>Hangout Planner · 免费联网版（不用 OpenAI）</h1>
    <div class="row">
      <div><label>城市/区域</label><input id="city" placeholder="如：上海徐汇 / Beijing Sanlitun"></div>
      <div><label>日期</label><input id="date" type="date"></div>
      <div><label>开始时间</label><input id="start" type="time" value="18:00"></div>
      <div><label>总时长（小时）</label><input id="hours" type="number" step="0.5" value="4"></div>
      <div><label>氛围</label>
        <select id="vibe">
          <option value="chill">轻松随性</option><option value="active">运动活力</option>
          <option value="cultural">文化/展览</option><option value="romantic">浪漫</option>
          <option value="party">热闹</option><option value="family">亲子</option>
        </select>
      </div>
      <div><label>半径（米）</label><input id="radius" type="number" value="2000"></div>
      <div><label>必须包含（逗号分隔）</label><input id="must" placeholder="咖啡, 甜品, 桌游"></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn primary" id="go">联网搜一套方案</button>
      <button class="btn" id="ics" disabled>下载 .ics</button>
    </div>
    <small class="hint">把 <code>assets/bg.png</code> 换成你的手绘图即可拥有你的 UI 风格。若要更丰富地点数据，可去 Vercel 的环境变量增加 <code>OPENTRIPMAP_KEY</code>（免费注册）。</small>
  </div>

  <div class="grid" style="margin-top:12px">
    <div class="card">
      <h3 style="margin:4px 0 8px">时间轴</h3>
      <div id="timeline" class="timeline">（点击上面的按钮生成）</div>
    </div>
    <div class="card">
      <h3 style="margin:4px 0 8px">候选地点</h3>
      <div id="places">（生成后显示附近餐馆/咖啡/景点）</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3 style="margin:4px 0 8px">可复制文本</h3>
    <pre id="out" class="code">（生成后会出现完整说明）</pre>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const vibeKinds = {
  chill: "foods,cafes,interesting_places",
  cultural: "museums,galleries,theatres,heritage,monuments",
  romantic: "foods,cafes,bridges,view_points,parks",
  party: "pubs,bars,clubs,foods",
  active: "sport,swimming_pools,skating,raceways,stadiums,parks",
  family: "amusements,aquariums,zoos,theme_parks,playgrounds,foods"
};
let latest = null;

$("#go").onclick = async () => {
  $("#timeline").textContent = "搜索中…";
  $("#places").textContent = "加载附近地点…";
  $("#out").textContent = "";
  $("#ics").disabled = true;

  const input = readUI();
  const geo = await fetchJSON(`/api/geo?q=${encodeURIComponent(input.city)}`);
  if (!geo.length) { $("#timeline").textContent = "找不到这个城市/区域"; return; }
  const { lat, lon } = geo[0];

  const places = await fetchJSON(`/api/places?lat=${lat}&lon=${lon}&radius=${input.radius}&kinds=${encodeURIComponent(vibeKinds[input.vibe])}`);
  const weather = await fetchJSON(`/api/weather?lat=${lat}&lon=${lon}`);

  renderPlaces(places);
  const plan = composePlan(input, places, weather);
  renderTimeline(plan);
  $("#out").textContent = plan.full_text;
  latest = plan;
  $("#ics").disabled = false;
};

$("#ics").onclick = () => {
  if (!latest) return;
  const segs = latest.segments;
  const first = segs[0], last = segs[segs.length-1];
  const ics = toICS({title: latest.title, startISO: first.isoStart, endISO: last.isoEnd, description: latest.full_text});
  downloadBlob(ics, 'text/calendar;charset=utf-8', 'hangout.ics');
};

function readUI(){ const must = ($("#must").value||"").split(/[，,]/).map(s=>s.trim()).filter(Boolean);
  return { city: $("#city").value.trim(), date: $("#date").value, start: $("#start").value, hours: Number($("#hours").value||4),
           vibe: $("#vibe").value, radius: Number($("#radius").value||2000), must };
}

function renderPlaces(list){
  const box = $("#places"); box.innerHTML = "";
  if (!list || !list.length) { box.textContent = "未找到合适地点（可放大半径或换氛围）"; return; }
  list.forEach(p => {
    const addr = p.address ? Object.values(p.address).join(" ") : "";
    const gmap = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.name)}%20@${p.lat},${p.lon}`;
    const el = document.createElement("div");
    el.className = "place";
    el.innerHTML = `<div><b>${p.name||'未命名'}</b> · 评分 ${p.rate||'-'} </div>
      <div style="font-size:12px;color:#6b7280">${addr}</div>
      <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn" href="${gmap}" target="_blank">地图</a>
        ${p.url?`<a class="btn" href="${p.url}" target="_blank">官网</a>`:''}
      </div>`;
    box.appendChild(el);
  });
}

function composePlan(input, places, weather){
  const startISO = toISOdateTime(input.date, input.start);
  let cur = new Date(startISO);
  const add = mins => new Date(cur.getTime() + mins*60000);
  const segs = [];
  const pick = (filterFn) => {
    const idx = places.findIndex(filterFn);
    return idx>=0 ? places.splice(idx,1)[0] : null;
  };
  // pick place types heuristic
  const cafe = pick(p => /cafe|coffee/i.test(p.kinds||""));
  const food = pick(p => /foods|restaurants|fast_food/i.test(p.kinds||""));
  const poi  = pick(p => /muse|gallery|view|park|heritage|zoo|aquarium|amuse|theme/i.test(p.kinds||""));
  const another = places[0];

  function push(label, mins, place, extra=""){
    const s = new Date(cur), e = add(mins);
    segs.push({
      label, start: fmtHM(s), end: fmtHM(e),
      isoStart: s.toISOString(), isoEnd: e.toISOString(),
      place: place ? place.name : null,
      coord: place ? [place.lat, place.lon] : null,
      detail: place ? `${place.name}${extra ? " · "+extra : ""}` : extra
    });
    cur = e;
  }

  // weather hint
  let rainHint = "";
  const dailyRain = weather?.daily?.precipitation_probability_max?.[0];
  if (dailyRain>=60) rainHint = "（降雨概率较高，优先室内）";

  // schedule
  push("集合", 15, null, `${input.city} 指定点集合${rainHint}`);
  if (cafe) push("热身咖啡", 45, cafe);
  if (poi)  push("主活动", Math.min(120, Math.max(60, Math.round(input.hours*60-120))), poi);
  push("用餐", 60, food || another);
  if (another) push("散步/加点", 45, another);

  const full = describePlan(input, segs);
  return { title: `${input.city} · ${input.vibe} · ${fmtDate(new Date(startISO))}`, segments: segs, full_text: full };
}

function describePlan(input, segs){
  const lines = [];
  lines.push(`【主题】${input.city} · ${input.vibe}`);
  lines.push(`【时间】${input.date||'某日'} ${input.start||''} 起 · 约 ${input.hours} 小时`);
  lines.push("");
  segs.forEach(s => lines.push(`- ${s.start}–${s.end} · ${s.label}${s.detail?'：'+s.detail:''}`));
  lines.push("");
  lines.push("【备注】可根据现场状况调整顺序；高峰期建议提前排队或订位。");
  return lines.join("\n");
}

async function fetchJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }
function fmtHM(d){const p=n=>String(n).padStart(2,'0');return p(d.getHours())+':'+p(d.getMinutes());}
function toISOdateTime(dateStr,timeStr){ if(!dateStr||!timeStr){const d=new Date(); return d.toISOString();}
  const [Y,M,D] = dateStr.split('-').map(Number); const [h,m] = timeStr.split(':').map(Number);
  return new Date(Y,M-1,D,h,m,0).toISOString();
}
function fmtDate(d){const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;}
function toICS({title,startISO,endISO,description}){
  const pad=n=>String(n).padStart(2,'0'); const fmt=iso=>{const d=new Date(iso);
    return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+'T'+pad(d.getUTCHours())+pad(d.getUTCMinutes())+'Z';};
  return ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Hangout Search Free//EN','BEGIN:VEVENT',
          'UID:'+Math.random().toString(36).slice(2),'DTSTAMP:'+fmt(new Date().toISOString()),
          'DTSTART:'+fmt(startISO),'DTEND:'+fmt(endISO),'SUMMARY:'+title.replace(/\n/g,' '),
          'DESCRIPTION:'+String(description||'').replace(/\n/g,'\\n'),
          'END:VEVENT','END:VCALENDAR'].join('\r\n');
}
function downloadBlob(text,mime,filename){ const blob=new Blob([text],{type:mime}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}
</script>
</body>
</html>
